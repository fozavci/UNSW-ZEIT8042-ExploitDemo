// This code can be compiled with Borland C++ Free Compiler
// Available : https://www.embarcadero.com/free-tools/ccompiler
// 
// -w-all disables all warnings as the compiler warns for the format string bugs
// C:\BCC102\bin\bcc32c.exe -w-all -o stackvulnerable-console.exe stackvulnerable-console.c

#include <stdio.h>
#include <sys/stat.h>
#include <stdbool.h>

int main(int argc, char *argv[])
{
	char fname[1024];
	char data[1000];
	if (argc > 1) {
		printf(argv[1]);
		// Reading the file
		strcpy(fname,argv[1]);
		fileread(fname);
	}
	else {
		while (1) {
			// Asking file name to read from
			printf("\nFile name to read?\n");
			// The following line has a Stack Overflow bug
			// The reason is copying argument to name variable without a boundary check	
			// scanf("%s",fname);
			gets(fname);
			
			// There is a format string bug in the following line
			// The problem is not formatting the string 
			// Such as printf("Name: %s",argv[1]); 
			printf(fname);							
			
			// Reading the file
			fileread(data,fname);
		}
	}		
}

int fileread(char *data, char *fname) {

	// Setting up variables
	FILE *file;
	char buff[1255];
	struct stat sb;
	
	// Checking whether the file exists or not
	if ( stat (fname,&sb) == 0) {
		file = fopen(fname, "r");
	
		// The following line has a Stack Overflow bug
		// The reason is copying argument to name variable with a boundary check
		// CMP BYTE PTR DS:[EBX+17],BL
		// fscanf(file, "%s", buff);
		fgets(buff, 1255, file);	
		
		// Closing the file
		fclose(file);
		
		// Copy the data to the pointer given
		strcpy(data,buff);
		
		return 0;
	} 
	else {
		printf("File does not exist!");
		return 1;
	}

	
}
